"use strict";

exports.__esModule = true;
exports.nextYear = nextYear;
exports.nextMonth = nextMonth;
exports.nextHour = nextHour;
exports.updateQueryStringParameter = updateQueryStringParameter;
exports.isLaterVersion = isLaterVersion;
exports.hexStringToECPair = hexStringToECPair;
exports.ecPairToHexString = ecPairToHexString;
exports.ecPairToAddress = ecPairToAddress;
exports.makeUUID4 = makeUUID4;
exports.isSameOriginAbsoluteUrl = isSameOriginAbsoluteUrl;
exports.BLOCKSTACK_HANDLER = void 0;

var _url = _interopRequireDefault(require("url"));

var _bitcoinjsLib = require("bitcoinjs-lib");

var _config = require("./config");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const BLOCKSTACK_HANDLER = 'blockstack';
/**
 * Time
 * @private
 */

exports.BLOCKSTACK_HANDLER = BLOCKSTACK_HANDLER;

function nextYear() {
  return new Date(new Date().setFullYear(new Date().getFullYear() + 1));
}

function nextMonth() {
  return new Date(new Date().setMonth(new Date().getMonth() + 1));
}

function nextHour() {
  return new Date(new Date().setHours(new Date().getHours() + 1));
}
/**
 * Query Strings
 * @private
 */


function updateQueryStringParameter(uri, key, value) {
  const re = new RegExp(`([?&])${key}=.*?(&|$)`, 'i');
  const separator = uri.indexOf('?') !== -1 ? '&' : '?';

  if (uri.match(re)) {
    return uri.replace(re, `$1${key}=${value}$2`);
  } else {
    return `${uri}${separator}${key}=${value}`;
  }
}
/**
 * Versioning
 * @param {string} v1 - the left half of the version inequality
 * @param {string} v2 - right half of the version inequality
 * @returns {bool} iff v1 >= v2
 * @private
 */


function isLaterVersion(v1, v2) {
  if (v1 === undefined) {
    v1 = '0.0.0';
  }

  if (v2 === undefined) {
    v2 = '0.0.0';
  }

  const v1tuple = v1.split('.').map(x => parseInt(x, 10));
  const v2tuple = v2.split('.').map(x => parseInt(x, 10));

  for (let index = 0; index < v2.length; index++) {
    if (index >= v1.length) {
      v2tuple.push(0);
    }

    if (v1tuple[index] < v2tuple[index]) {
      return false;
    }
  }

  return true;
}

function hexStringToECPair(skHex) {
  const ecPairOptions = {
    network: _config.config.network.layer1,
    compressed: true
  };

  if (skHex.length === 66) {
    if (skHex.slice(64) !== '01') {
      throw new Error('Improperly formatted private-key hex string. 66-length hex usually ' + 'indicates compressed key, but last byte must be == 1');
    }

    return _bitcoinjsLib.ECPair.fromPrivateKey(new Buffer(skHex.slice(0, 64), 'hex'), ecPairOptions);
  } else if (skHex.length === 64) {
    ecPairOptions.compressed = false;
    return _bitcoinjsLib.ECPair.fromPrivateKey(new Buffer(skHex, 'hex'), ecPairOptions);
  } else {
    throw new Error('Improperly formatted private-key hex string: length should be 64 or 66.');
  }
}

function ecPairToHexString(secretKey) {
  const ecPointHex = secretKey.privateKey.toString('hex');

  if (secretKey.compressed) {
    return `${ecPointHex}01`;
  } else {
    return ecPointHex;
  }
}

function ecPairToAddress(keyPair) {
  return _bitcoinjsLib.address.toBase58Check(_bitcoinjsLib.crypto.hash160(keyPair.publicKey), keyPair.network.pubKeyHash);
}
/**
 * UUIDs
 * @private
 */


function makeUUID4() {
  let d = new Date().getTime();

  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {
    d += performance.now(); // use high-precision timer if available
  }

  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = (d + Math.random() * 16) % 16 | 0;
    d = Math.floor(d / 16);
    return (c === 'x' ? r : r & 0x3 | 0x8).toString(16);
  });
}
/**
 * Checks if both urls pass the same origin check & are absolute
 * @param  {[type]}  uri1 first uri to check
 * @param  {[type]}  uri2 second uri to check
 * @return {Boolean} true if they pass the same origin check
 * @private
 */


function isSameOriginAbsoluteUrl(uri1, uri2) {
  const parsedUri1 = _url.default.parse(uri1);

  const parsedUri2 = _url.default.parse(uri2);

  const port1 = parseInt(parsedUri1.port, 10) | 0 || (parsedUri1.protocol === 'https:' ? 443 : 80);
  const port2 = parseInt(parsedUri2.port, 10) | 0 || (parsedUri2.protocol === 'https:' ? 443 : 80);
  const match = {
    scheme: parsedUri1.protocol === parsedUri2.protocol,
    hostname: parsedUri1.hostname === parsedUri2.hostname,
    port: port1 === port2,
    absolute: (uri1.includes('http://') || uri1.includes('https://')) && (uri2.includes('http://') || uri2.includes('https://'))
  };
  return match.scheme && match.hostname && match.port && match.absolute;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy5qcyJdLCJuYW1lcyI6WyJCTE9DS1NUQUNLX0hBTkRMRVIiLCJuZXh0WWVhciIsIkRhdGUiLCJzZXRGdWxsWWVhciIsImdldEZ1bGxZZWFyIiwibmV4dE1vbnRoIiwic2V0TW9udGgiLCJnZXRNb250aCIsIm5leHRIb3VyIiwic2V0SG91cnMiLCJnZXRIb3VycyIsInVwZGF0ZVF1ZXJ5U3RyaW5nUGFyYW1ldGVyIiwidXJpIiwia2V5IiwidmFsdWUiLCJyZSIsIlJlZ0V4cCIsInNlcGFyYXRvciIsImluZGV4T2YiLCJtYXRjaCIsInJlcGxhY2UiLCJpc0xhdGVyVmVyc2lvbiIsInYxIiwidjIiLCJ1bmRlZmluZWQiLCJ2MXR1cGxlIiwic3BsaXQiLCJtYXAiLCJ4IiwicGFyc2VJbnQiLCJ2MnR1cGxlIiwiaW5kZXgiLCJsZW5ndGgiLCJwdXNoIiwiaGV4U3RyaW5nVG9FQ1BhaXIiLCJza0hleCIsImVjUGFpck9wdGlvbnMiLCJuZXR3b3JrIiwiY29uZmlnIiwibGF5ZXIxIiwiY29tcHJlc3NlZCIsInNsaWNlIiwiRXJyb3IiLCJFQ1BhaXIiLCJmcm9tUHJpdmF0ZUtleSIsIkJ1ZmZlciIsImVjUGFpclRvSGV4U3RyaW5nIiwic2VjcmV0S2V5IiwiZWNQb2ludEhleCIsInByaXZhdGVLZXkiLCJ0b1N0cmluZyIsImVjUGFpclRvQWRkcmVzcyIsImtleVBhaXIiLCJhZGRyZXNzIiwidG9CYXNlNThDaGVjayIsImNyeXB0byIsImhhc2gxNjAiLCJwdWJsaWNLZXkiLCJwdWJLZXlIYXNoIiwibWFrZVVVSUQ0IiwiZCIsImdldFRpbWUiLCJwZXJmb3JtYW5jZSIsIm5vdyIsImMiLCJyIiwiTWF0aCIsInJhbmRvbSIsImZsb29yIiwiaXNTYW1lT3JpZ2luQWJzb2x1dGVVcmwiLCJ1cmkxIiwidXJpMiIsInBhcnNlZFVyaTEiLCJ1cmwiLCJwYXJzZSIsInBhcnNlZFVyaTIiLCJwb3J0MSIsInBvcnQiLCJwcm90b2NvbCIsInBvcnQyIiwic2No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QUM4QyxVQUFVLENBQUNFLElBQVosRUFBa0IsRUFBbEIsQ0FBUixHQUFnQyxDQUFoQyxLQUFzQ0YsVUFBVSxDQUFDRyxRQUFYLEtBQXdCLFFBQXhCLEdBQW1DLEdBQW5DLEdBQXlDLEVBQS9FLENBQWQ7QUFFQSxRQUFNM0QsS0FBSyxHQUFHO0FBQ1o2RCxJQUFBQSxNQUFNLEVBQUVSLFVBQVUsQ0FBQ00sUUFBWCxLQUF3QkgsVUFBVSxDQUFDRyxRQUQvQjtBQUVaRyxJQUFBQSxRQUFRLEVBQUVULFVBQVUsQ0FBQ1MsUUFBWCxLQUF3Qk4sVUFBVSxDQUFDTSxRQUZqQztBQUdaSixJQUFBQSxJQUFJLEVBQUVELEtBQUssS0FBS0csS0FISjtBQUlaRyxJQUFBQSxRQUFRLEVBQUUsQ0FBQ1osSUFBSSxDQUFDYSxRQUFMLENBQWMsU0FBZCxLQUE0QmIsSUFBSSxDQUFDYSxRQUFMLENBQWMsVUFBZCxDQUE3QixNQUNOWixJQUFJLENBQUNZLFFBQUwsQ0FBYyxTQUFkLEtBQTRCWixJQUFJLENBQUNZLFFBQUwsQ0FBYyxVQUFkLENBRHRCO0FBSkUsR0FBZDtBQVFBLFNBQU9oRSxLQUFLLENBQUM2RCxNQUFOLElBQWdCN0QsS0FBSyxDQUFDOEQsUUFBdEIsSUFBa0M5RCxLQUFLLENBQUMwRCxJQUF4QyxJQUFnRDFELEtBQUssQ0FBQytELFFBQTdEO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuaW1wb3J0IHVybCBmcm9tICd1cmwnXG5pbXBvcnQgeyBFQ1BhaXIsIGFkZHJlc3MsIGNyeXB0byB9IGZyb20gJ2JpdGNvaW5qcy1saWInXG5pbXBvcnQgeyBjb25maWcgfSBmcm9tICcuL2NvbmZpZydcblxuZXhwb3J0IGNvbnN0IEJMT0NLU1RBQ0tfSEFORExFUiA9ICdibG9ja3N0YWNrJ1xuLyoqXG4gKiBUaW1lXG4gKiBAcHJpdmF0ZVxuICovXG5cbmV4cG9ydCBmdW5jdGlvbiBuZXh0WWVhcigpIHtcbiAgcmV0dXJuIG5ldyBEYXRlKFxuICAgIG5ldyBEYXRlKCkuc2V0RnVsbFllYXIoXG4gICAgICBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCkgKyAxXG4gICAgKVxuICApXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBuZXh0TW9udGgoKSB7XG4gIHJldHVybiBuZXcgRGF0ZShcbiAgICBuZXcgRGF0ZSgpLnNldE1vbnRoKFxuICAgICAgbmV3IERhdGUoKS5nZXRNb250aCgpICsgMVxuICAgIClcbiAgKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbmV4dEhvdXIoKSB7XG4gIHJldHVybiBuZXcgRGF0ZShcbiAgICBuZXcgRGF0ZSgpLnNldEhvdXJzKFxuICAgICAgbmV3IERhdGUoKS5nZXRIb3VycygpICsgMVxuICAgIClcbiAgKVxufVxuXG4vKipcbiAqIFF1ZXJ5IFN0cmluZ3NcbiAqIEBwcml2YXRlXG4gKi9cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVF1ZXJ5U3RyaW5nUGFyYW1ldGVyKHVyaTogc3RyaW5nLCBrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xuICBjb25zdCByZSA9IG5ldyBSZWdFeHAoYChbPyZdKSR7a2V5fT0uKj8oJnwkKWAsICdpJylcbiAgY29uc3Qgc2VwYXJhdG9yID0gdXJpLmluZGV4T2YoJz8nKSAhPT0gLTEgPyAnJicgOiAnPydcbiAgaWYgKHVyaS5tYXRjaChyZSkpIHtcbiAgICByZXR1cm4gdXJpLnJlcGxhY2UocmUsIGAkMSR7a2V5fT0ke3ZhbHVlfSQyYClcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYCR7dXJpfSR7c2VwYXJhdG9yfSR7a2V5fT0ke3ZhbHVlfWBcbiAgfVxufVxuXG4vKipcbiAqIFZlcnNpb25pbmdcbiAqIEBwYXJhbSB7c3RyaW5nfSB2MSAtIHRoZSBsZWZ0IGhhbGYgb2YgdGhlIHZlcnNpb24gaW5lcXVhbGl0eVxuICogQHBhcmFtIHtzdHJpbmd9IHYyIC0gcmlnaHQgaGFsZiBvZiB0aGUgdmVyc2lvbiBpbmVxdWFsaXR5XG4gKiBAcmV0dXJucyB7Ym9vbH0gaWZmIHYxID49IHYyXG4gKiBAcHJpdmF0ZVxuICovXG5cbmV4cG9ydCBmdW5jdGlvbiBpc0xhdGVyVmVyc2lvbih2MTogc3RyaW5nLCB2Mjogc3RyaW5nKSB7XG4gIGlmICh2MSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgdjEgPSAnMC4wLjAnXG4gIH1cblxuICBpZiAodjIgPT09IHVuZGVmaW5lZCkge1xuICAgIHYyID0gJzAuMC4wJ1xuICB9XG5cbiAgY29uc3QgdjF0dXBsZSA9IHYxLnNwbGl0KCcuJykubWFwKHggPT4gcGFyc2VJbnQoeCwgMTApKVxuICBjb25zdCB2MnR1cGxlID0gdjIuc3BsaXQoJy4nKS5tYXAoeCA9PiBwYXJzZUludCh4LCAxMCkpXG5cbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHYyLmxlbmd0aDsgaW5kZXgrKykge1xuICAgIGlmIChpbmRleCA+PSB2MS5sZW5ndGgpIHtcbiAgICAgIHYydHVwbGUucHVzaCgwKVxuICAgIH1cbiAgICBpZiAodjF0dXBsZVtpbmRleF0gPCB2MnR1cGxlW2luZGV4XSkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9XG4gIHJldHVybiB0cnVlXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoZXhTdHJpbmdUb0VDUGFpcihza0hleDogc3RyaW5nKSB7XG4gIGNvbnN0IGVjUGFpck9wdGlvbnMgPSB7XG4gICAgbmV0d29yazogY29uZmlnLm5ldHdvcmsubGF5ZXIxLFxuICAgIGNvbXByZXNzZWQ6IHRydWVcbiAgfVxuXG4gIGlmIChza0hleC5sZW5ndGggPT09IDY2KSB7XG4gICAgaWYgKHNrSGV4LnNsaWNlKDY0KSAhPT0gJzAxJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbXByb3Blcmx5IGZvcm1hdHRlZCBwcml2YXRlLWtleSBoZXggc3RyaW5nLiA2Ni1sZW5ndGggaGV4IHVzdWFsbHkgJ1xuICAgICAgICAgICAgICAgICAgICAgICsgJ2luZGljYXRlcyBjb21wcmVzc2VkIGtleSwgYnV0IGxhc3QgYnl0ZSBtdXN0IGJlID09IDEnKVxuICAgIH1cbiAgICByZXR1cm4gRUNQYWlyLmZyb21Qcml2YXRlS2V5KG5ldyBCdWZmZXIoc2tIZXguc2xpY2UoMCwgNjQpLCAnaGV4JyksIGVjUGFpck9wdGlvbnMpXG4gIH0gZWxzZSBpZiAoc2tIZXgubGVuZ3RoID09PSA2NCkge1xuICAgIGVjUGFpck9wdGlvbnMuY29tcHJlc3NlZCA9IGZhbHNlXG4gICAgcmV0dXJuIEVDUGFpci5mcm9tUHJpdmF0ZUtleShuZXcgQnVmZmVyKHNrSGV4LCAnaGV4JyksIGVjUGFpck9wdGlvbnMpXG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdJbXByb3Blcmx5IGZvcm1hdHRlZCBwcml2YXRlLWtleSBoZXggc3RyaW5nOiBsZW5ndGggc2hvdWxkIGJlIDY0IG9yIDY2LicpXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVjUGFpclRvSGV4U3RyaW5nKHNlY3JldEtleTogRUNQYWlyKSB7XG4gIGNvbnN0IGVjUG9pbnRIZXggPSBzZWNyZXRLZXkucHJpdmF0ZUtleS50b1N0cmluZygnaGV4JylcbiAgaWYgKHNlY3JldEtleS5jb21wcmVzc2VkKSB7XG4gICAgcmV0dXJuIGAke2VjUG9pbnRIZXh9MDFgXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGVjUG9pbnRIZXhcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZWNQYWlyVG9BZGRyZXNzKGtleVBhaXI6IEVDUGFpcikge1xuICByZXR1cm4gYWRkcmVzcy50b0Jhc2U1OENoZWNrKGNyeXB0by5oYXNoMTYwKGtleVBhaXIucHVibGljS2V5KSwga2V5UGFpci5uZXR3b3JrLnB1YktleUhhc2gpXG59XG5cbi8qKlxuICogVVVJRHNcbiAqIEBwcml2YXRlXG4gKi9cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VVVUlENCgpIHtcbiAgbGV0IGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKVxuICBpZiAodHlwZW9mIHBlcmZvcm1hbmNlICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgZCArPSBwZXJmb3JtYW5jZS5ub3coKSAvLyB1c2UgaGlnaC1wcmVjaXNpb24gdGltZXIgaWYgYXZhaWxhYmxlXG4gIH1cbiAgcmV0dXJuICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywgKGMpID0+IHtcbiAgICBjb25zdCByID0gKGQgKyBNYXRoLnJhbmRvbSgpICogMTYpICUgMTYgfCAwXG4gICAgZCA9IE1hdGguZmxvb3IoZCAvIDE2KVxuICAgIHJldHVybiAoYyA9PT0gJ3gnID8gciA6IChyICYgMHgzIHwgMHg4KSkudG9TdHJpbmcoMTYpXG4gIH0pXG59XG5cbi8qKlxuICogQ2hlY2tzIGlmIGJvdGggdXJscyBwYXNzIHRoZSBzYW1lIG9yaWdpbiBjaGVjayAmIGFyZSBhYnNvbHV0ZVxuICogQHBhcmFtICB7W3R5cGVdfSAgdXJpMSBmaXJzdCB1cmkgdG8gY2hlY2tcbiAqIEBwYXJhbSAge1t0eXBlXX0gIHVyaTIgc2Vjb25kIHVyaSB0byBjaGVja1xuICogQHJldHVybiB7Qm9vbGVhbn0gdHJ1ZSBpZiB0aGV5IHBhc3MgdGhlIHNhbWUgb3JpZ2luIGNoZWNrXG4gKiBAcHJpdmF0ZVxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNTYW1lT3JpZ2luQWJzb2x1dGVVcmwodXJpMTogc3RyaW5nLCB1cmkyOiBzdHJpbmcpIHtcbiAgY29uc3QgcGFyc2VkVXJpMSA9IHVybC5wYXJzZSh1cmkxKVxuICBjb25zdCBwYXJzZWRVcmkyID0gdXJsLnBhcnNlKHVyaTIpXG5cbiAgY29uc3QgcG9ydDEgPSBwYXJzZUludChwYXJzZWRVcmkxLnBvcnQsIDEwKSB8IDAgfHwgKHBhcnNlZFVyaTEucHJvdG9jb2wgPT09ICdodHRwczonID8gNDQzIDogODApXG4gIGNvbnN0IHBvcnQyID0gcGFyc2VJbnQocGFyc2VkVXJpMi5wb3J0LCAxMCkgfCAwIHx8IChwYXJzZWRVcmkyLnByb3RvY29sID09PSAnaHR0cHM6JyA/IDQ0MyA6IDgwKVxuXG4gIGNvbnN0IG1hdGNoID0ge1xuICAgIHNjaGVtZTogcGFyc2VkVXJpMS5wcm90b2NvbCA9PT0gcGFyc2VkVXJpMi5wcm90b2NvbCxcbiAgICBob3N0bmFtZTogcGFyc2VkVXJpMS5ob3N0bmFtZSA9PT0gcGFyc2VkVXJpMi5ob3N0bmFtZSxcbiAgICBwb3J0OiBwb3J0MSA9PT0gcG9ydDIsXG4gICAgYWJzb2x1dGU6ICh1cmkxLmluY2x1ZGVzKCdodHRwOi8vJykgfHwgdXJpMS5pbmNsdWRlcygnaHR0cHM6Ly8nKSlcbiAgICAmJiAodXJpMi5pbmNsdWRlcygnaHR0cDovLycpIHx8IHVyaTIuaW5jbHVkZXMoJ2h0dHBzOi8vJykpXG4gIH1cblxuICByZXR1cm4gbWF0Y2guc2NoZW1lICYmIG1hdGNoLmhvc3RuYW1lICYmIG1hdGNoLnBvcnQgJiYgbWF0Y2guYWJzb2x1dGVcbn1cbiJdfQ==