"use strict";

exports.__esModule = true;
exports.makeProfileZoneFile = makeProfileZoneFile;
exports.getTokenFileUrl = getTokenFileUrl;
exports.resolveZoneFileToProfile = resolveZoneFileToProfile;

var _zoneFile = require("zone-file");

var _profileTokens = require("./profileTokens");

var _index = require("./index");

var _logger = require("../logger");

function makeProfileZoneFile(origin, tokenFileUrl) {
  if (tokenFileUrl.indexOf('://') < 0) {
    throw new Error('Invalid token file url');
  }

  const urlScheme = tokenFileUrl.split('://')[0];
  const urlParts = tokenFileUrl.split('://')[1].split('/');
  const domain = urlParts[0];
  const pathname = `/${urlParts.slice(1).join('/')}`;
  const zoneFile = {
    $origin: origin,
    $ttl: 3600,
    uri: [{
      name: '_http._tcp',
      priority: 10,
      weight: 1,
      target: `${urlScheme}://${domain}${pathname}`
    }]
  };
  const zoneFileTemplate = '{$origin}\n{$ttl}\n{uri}\n';
  return (0, _zoneFile.makeZoneFile)(zoneFile, zoneFileTemplate);
}

function getTokenFileUrl(zoneFileJson) {
  if (!zoneFileJson.hasOwnProperty('uri')) {
    return null;
  }

  if (!Array.isArray(zoneFileJson.uri)) {
    return null;
  }

  if (zoneFileJson.uri.length < 1) {
    return null;
  }

  const firstUriRecord = zoneFileJson.uri[0];

  if (!firstUriRecord.hasOwnProperty('target')) {
    return null;
  }

  let tokenFileUrl = firstUriRecord.target;

  if (tokenFileUrl.startsWith('https')) {// pass
  } else if (tokenFileUrl.startsWith('http')) {// pass
  } else {
    tokenFileUrl = `https://${tokenFileUrl}`;
  }

  return tokenFileUrl;
}

function resolveZoneFileToProfile(zoneFile, publicKeyOrAddress) {
  return new Promise((resolve, reject) => {
    let zoneFileJson = null;

    try {
      zoneFileJson = (0, _zoneFile.parseZoneFile)(zoneFile);

      if (!zoneFileJson.hasOwnProperty('$origin')) {
        zoneFileJson = null;
      }
    } catch (e) {
      reject(e);
    }

    let tokenFileUrl = null;

    if (zoneFileJson && Object.keys(zoneFileJson).length > 0) {
      tokenFileUrl = getTokenFileUrl(zoneFileJson);
    } else {
      let profile = null;

      try {
        profile = JSON.parse(zoneFile);
        profile = _index.Person.fromLegacyFormat(profile).profile();
      } catch (error) {
        reject(error);
      }

      resolve(profile);
      return;
    }

    if (tokenFileUrl) {
      fetch(tokenFileUrl).then(response => response.text()).then(responseText => JSON.parse(responseText)).then(responseJson => {
        const tokenRecords = responseJson;
        const profile = (0, _profileTokens.extractProfile)(tokenRecords[0].token, publicKeyOrAddress);
        resolve(profile);
      }).catch(error => {
        _logger.Logger.error(`resolveZoneFileToProfile: error fetching token file ${tokenFileUrl}`, error);

        reject(error);
      });
    } else {
      _logger.Logger.debug('Token file url not found. Resolving to blank profile.');

      resolve({});
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wcm9maWxlcy9wcm9maWxlWm9uZUZpbGVzLmpzIl0sIm5hbWVzIjpbIm1ha2VQcm9maWxlWm9uZUZpbGUiLCJvcmlnaW4iLCJ0b2tlbkZpbGVVcmwiLCJpbmRleE9mIiwiRXJyb3IiLCJ1cmxTY2hlbWUiLCJzcGxpdCIsInVybFBhcnRzIiwiZG9tYWluIiwicGF0aG5hbWUiLCJzbGljZSIsImpvaW4iLCJ6b25lRmlsZSIsIiRvcmlnaW4iLCIkdHRsIiwidXJpIiwibmFtZSIsInByaW9yaXR5Iiwid2VpZ2h0IiwidGFyZ2V0Iiwiem9uZUZpbGVUZW1wbGF0ZSIsImdldFRva2VuRmlsZVVybCIsInpvbmVGaWxlSnNvbiIsImhhc093blByb3BlcnR5IiwiQXJyYXkiLCJpc0FycmF5IiwibGVuZ3RoIiwiZmlyc3RVcmlSZWNvcmQiLCJzdGFydHNXaXRoIiwicmVzb2x2ZVpvbmVGaWxlVG9Qcm9maWxlIiwicHVibGljS2V5T3JBZGRyZXNzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJlIiwiT2JqZWN0Iiwia2V5cyIsInByb2ZpbGUiLCJKU09OIiwicGFyc2UiLCJQZXJzb24iLCJmcm9tTGVnYWN5Rm9ybWF0IiwiZXJyb3IiLCJmZXRjaCIsInRoZW4iLCJyZXNwb25zZSIsInRleHQiLCJyZXNwb25zZVRleHQiLCJyZXNwb25zZUpzb24iLCJ0b2tlblJlY29yZHMiLCJ0b2tlbiIsImNhdGNoIiwiTG9nZ2VyIiwiZGVidWciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFFTyxTQUFTQSxtQkFBVCxDQUE2QkMsTUFBN0IsRUFBcUNDLFlBQXJDLEVBQW1EO0FBQ3hELE1BQUlBLFlBQVksQ0FBQ0MsT0FBYixDQUFxQixLQUFyQixJQUE4QixDQUFsQyxFQUFxQztBQUNuQyxVQUFNLElBQUlDLEtBQUosQ0FBVSx3QkFBVixDQUFOO0FBQ0Q7O0FBRUQsUUFBTUMsU0FBUyxHQUFHSCxZQUFZLENBQUNJLEtB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IGZyb20gJ3pvbmUtZmlsZSdcbmltcG9ydCB7IGV4dHJhY3RQcm9maWxlIH0gZnJvbSAnLi9wcm9maWxlVG9rZW5zJ1xuaW1wb3J0IHsgUGVyc29uIH0gZnJvbSAnLi9pbmRleCdcblxuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyJ1xuXG5leHBvcnQgZnVuY3Rpb24gbWFrZVByb2ZpbGVab25lRmlsZShvcmlnaW4sIHRva2VuRmlsZVVybCkge1xuICBpZiAodG9rZW5GaWxlVXJsLmluZGV4T2YoJzovLycpIDwgMCkge1xuICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCB0b2tlbiBmaWxlIHVybCcpXG4gIH1cblxuICBjb25zdCB1cmxTY2hlbWUgPSB0b2tlbkZpbGVVcmwuc3BsaXQoJzovLycpWzBdXG4gIGNvbnN0IHVybFBhcnRzID0gdG9rZW5GaWxlVXJsLnNwbGl0KCc6Ly8nKVsxXS5zcGxpdCgnLycpXG4gIGNvbnN0IGRvbWFpbiA9IHVybFBhcnRzWzBdXG4gIGNvbnN0IHBhdGhuYW1lID0gYC8ke3VybFBhcnRzLnNsaWNlKDEpLmpvaW4oJy8nKX1gXG5cbiAgY29uc3Qgem9uZUZpbGUgPSB7XG4gICAgJG9yaWdpbjogb3JpZ2luLFxuICAgICR0dGw6IDM2MDAsXG4gICAgdXJpOiBbXG4gICAgICB7XG4gICAgICAgIG5hbWU6ICdfaHR0cC5fdGNwJyxcbiAgICAgICAgcHJpb3JpdHk6IDEwLFxuICAgICAgICB3ZWlnaHQ6IDEsXG4gICAgICAgIHRhcmdldDogYCR7dXJsU2NoZW1lfTovLyR7ZG9tYWlufSR7cGF0aG5hbWV9YFxuICAgICAgfVxuICAgIF1cbiAgfVxuXG4gIGNvbnN0IHpvbmVGaWxlVGVtcGxhdGUgPSAneyRvcmlnaW59XFxueyR0dGx9XFxue3VyaX1cXG4nXG5cblxuICByZXR1cm4gbWFrZVpvbmVGaWxlKHpvbmVGaWxlLCB6b25lRmlsZVRlbXBsYXRlKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VG9rZW5GaWxlVXJsKHpvbmVGaWxlSnNvbikge1xuICBpZiAoIXpvbmVGaWxlSnNvbi5oYXNPd25Qcm9wZXJ0eSgndXJpJykpIHtcbiAgICByZXR1cm4gbnVsbFxuICB9XG4gIGlmICghQXJyYXkuaXNBcnJheSh6b25lRmlsZUpzb24udXJpKSkge1xuICAgIHJldHVybiBudWxsXG4gIH1cbiAgaWYgKHpvbmVGaWxlSnNvbi51cmkubGVuZ3RoIDwgMSkge1xuICAgIHJldHVybiBudWxsXG4gIH1cbiAgY29uc3QgZmlyc3RVcmlSZWNvcmQgPSB6b25lRmlsZUpzb24udXJpWzBdXG5cbiAgaWYgKCFmaXJzdFVyaVJlY29yZC5oYXNPd25Qcm9wZXJ0eSgndGFyZ2V0JykpIHtcbiAgICByZXR1cm4gbnVsbFxuICB9XG4gIGxldCB0b2tlbkZpbGVVcmwgPSBmaXJzdFVyaVJlY29yZC50YXJnZXRcblxuICBpZiAodG9rZW5GaWxlVXJsLnN0YXJ0c1dpdGgoJ2h0dHBzJykpIHtcbiAgICAvLyBwYXNzXG4gIH0gZWxzZSBpZiAodG9rZW5GaWxlVXJsLnN0YXJ0c1dpdGgoJ2h0dHAnKSkge1xuICAgIC8vIHBhc3NcbiAgfSBlbHNlIHtcbiAgICB0b2tlbkZpbGVVcmwgPSBgaHR0cHM6Ly8ke3Rva2VuRmlsZVVybH1gXG4gIH1cblxuICByZXR1cm4gdG9rZW5GaWxlVXJsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlWm9uZUZpbGVUb1Byb2ZpbGUoem9uZUZpbGUsIHB1YmxpY0tleU9yQWRkcmVzcykge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGxldCB6b25lRmlsZUpzb24gPSBudWxsXG4gICAgdHJ5IHtcbiAgICAgIHpvbmVGaWxlSnNvbiA9IHBhcnNlWm9uZUZpbGUoem9uZUZpbGUpXG4gICAgICBpZiAoIXpvbmVGaWxlSnNvbi5oYXNPd25Qcm9wZXJ0eSgnJG9yaWdpbicpKSB7XG4gICAgICAgIHpvbmVGaWxlSnNvbiA9IG51bGxcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZWplY3QoZSlcbiAgICB9XG5cbiAgICBsZXQgdG9rZW5GaWxlVXJsID0gbnVsbFxuICAgIGlmICh6b25lRmlsZUpzb24gJiYgT2JqZWN0LmtleXMoem9uZUZpbGVKc29uKS5sZW5ndGggPiAwKSB7XG4gICAgICB0b2tlbkZpbGVVcmwgPSBnZXRUb2tlbkZpbGVVcmwoem9uZUZpbGVKc29uKVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgcHJvZmlsZSA9IG51bGxcbiAgICAgIHRyeSB7XG4gICAgICAgIHByb2ZpbGUgPSBKU09OLnBhcnNlKHpvbmVGaWxlKVxuICAgICAgICBwcm9maWxlID0gUGVyc29uLmZyb21MZWdhY3lGb3JtYXQocHJvZmlsZSkucHJvZmlsZSgpXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICB9XG4gICAgICByZXNvbHZlKHByb2ZpbGUpXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBpZiAodG9rZW5GaWxlVXJsKSB7XG4gICAgICBmZXRjaCh0b2tlbkZpbGVVcmwpXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLnRleHQoKSlcbiAgICAgICAgLnRoZW4ocmVzcG9uc2VUZXh0ID0+IEpTT04ucGFyc2UocmVzcG9uc2VUZXh0KSlcbiAgICAgICAgLnRoZW4oKHJlc3BvbnNlSnNvbikgPT4ge1xuICAgICAgICAgIGNvbnN0IHRva2VuUmVjb3JkcyA9IHJlc3BvbnNlSnNvblxuICAgICAgICAgIGNvbnN0IHByb2ZpbGUgPSBleHRyYWN0UHJvZmlsZSh0b2tlblJlY29yZHNbMF0udG9rZW4sIHB1YmxpY0tleU9yQWRkcmVzcylcbiAgICAgICAgICByZXNvbHZlKHByb2ZpbGUpXG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICBMb2dnZXIuZXJyb3IoYHJlc29sdmVab25lRmlsZVRvUHJvZmlsZTogZXJyb3IgZmV0Y2hpbmcgdG9rZW4gZmlsZSAke3Rva2VuRmlsZVVybH1gLCBlcnJvcilcbiAgICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIExvZ2dlci5kZWJ1ZygnVG9rZW4gZmlsZSB1cmwgbm90IGZvdW5kLiBSZXNvbHZpbmcgdG8gYmxhbmsgcHJvZmlsZS4nKVxuICAgICAgcmVzb2x2ZSh7fSlcbiAgICB9XG4gIH0pXG59XG4iXX0=