"use strict";

exports.__esModule = true;
exports.safety = void 0;

var _config = require("../config");

function isNameValid(fullyQualifiedName = '') {
  const NAME_PART_RULE = /^[a-z0-9\-_+]+$/;
  const LENGTH_MAX_NAME = 37;

  if (!fullyQualifiedName || fullyQualifiedName.length > LENGTH_MAX_NAME) {
    return Promise.resolve(false);
  }

  const nameParts = fullyQualifiedName.split('.');

  if (nameParts.length !== 2) {
    return Promise.resolve(false);
  }

  return Promise.resolve(nameParts.reduce((agg, namePart) => {
    if (!agg) {
      return false;
    } else {
      return NAME_PART_RULE.test(namePart);
    }
  }, true));
}

function isNamespaceValid(namespaceID) {
  const NAMESPACE_RULE = /^[a-z0-9\-_]{1,19}$/;
  return Promise.resolve(namespaceID.match(NAMESPACE_RULE) !== null);
}

function isNameAvailable(fullyQualifiedName) {
  return _config.config.network.getNameInfo(fullyQualifiedName).then(() => false).catch(e => {
    if (e.message === 'Name not found') {
      return true;
    } else {
      throw e;
    }
  });
}

function isNamespaceAvailable(namespaceID) {
  return _config.config.network.getNamespaceInfo(namespaceID).then(() => false).catch(e => {
    if (e.message === 'Namespace not found') {
      return true;
    } else {
      throw e;
    }
  });
}

function ownsName(fullyQualifiedName, ownerAddress) {
  return _config.config.network.getNameInfo(fullyQualifiedName).then(nameInfo => nameInfo.address === ownerAddress).catch(e => {
    if (e.message === 'Name not found') {
      return false;
    } else {
      throw e;
    }
  });
}

function revealedNamespace(namespaceID, revealAddress) {
  return _config.config.network.getNamespaceInfo(namespaceID).then(namespaceInfo => namespaceInfo.recipient_address === revealAddress).catch(e => {
    if (e.message === 'Namespace not found') {
      return false;
    } else {
      throw e;
    }
  });
}

function namespaceIsReady(namespaceID) {
  return _config.config.network.getNamespaceInfo(namespaceID).then(namespaceInfo => namespaceInfo.ready).catch(e => {
    if (e.message === 'Namespace not found') {
      return false;
    } else {
      throw e;
    }
  });
}

function namespaceIsRevealed(namespaceID) {
  return _config.config.network.getNamespaceInfo(namespaceID).then(namespaceInfo => !namespaceInfo.ready).catch(e => {
    if (e.message === 'Namespace not found') {
      return false;
    } else {
      throw e;
    }
  });
}

function isInGracePeriod(fullyQualifiedName) {
  const network = _config.config.network;
  return Promise.all([network.getNameInfo(fullyQualifiedName), network.getBlockHeight(), network.getGracePeriod(fullyQualifiedName)]).then(([nameInfo, blockHeight, gracePeriod]) => {
    const expiresAt = nameInfo.expire_block;
    return blockHeight >= expiresAt && blockHeight < gracePeriod + expiresAt;
  }).catch(e => {
    if (e.message === 'Name not found') {
      return false;
    } else {
      throw e;
    }
  });
}

function addressCanReceiveName(address) {
  return _config.config.network.getNamesOwned(address).then(names => Promise.all(names.map(name => isNameValid(name))).then(validNames => validNames.filter(nameValid => nameValid).length < 25));
}

function isAccountSpendable(address, tokenType, blockHeight) {
  return _config.config.network.getAccountStatus(address, tokenType).then(accountStatus => accountStatus.transfer_send_block_id >= blockHeight);
}

const safety = {
  addressCanReceiveName,
  isInGracePeriod,
  ownsName,
  isNameAvailable,
  isNameValid,
  isNamespaceValid,
  isNamespaceAvailable,
  revealedNamespace,
  namespaceIsReady,
  namespaceIsRevealed,
  isAccountSpendable
};
exports.safety = safety;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9vcGVyYXRpb25zL3NhZmV0eS5qcyJdLCJuYW1lcyI6WyJpc05hbWVWYWxpZCIsImZ1bGx5UXVhbGlmaWVkTmFtZSIsIk5BTUVfUEFSVF9SVUxFIiwiTEVOR1RIX01BWF9OQU1FIiwibGVuZ3RoIiwiUHJvbWlzZSIsInJlc29sdmUiLCJuYW1lUGFydHMiLCJzcGxpdCIsInJlZHVjZSIsImFnZyIsIm5hbWVQYXJ0IiwidGVzdCIsImlzTmFtZXNwYWNlVmFsaWQiLCJuYW1lc3BhY2VJRCIsIk5BTUVTUEFDRV9SVUxFIiwibWF0Y2giLCJpc05hbWVBdmFpbGFibGUiLCJjb25maWciLCJuZXR3b3JrIiwiZ2V0TmFtZUluZm8iLCJ0aGVuIiwiY2F0Y2giLCJlIiwibWVzc2FnZSIsImlzTmFtZXNwYWNlQXZhaWxhYmxlIiwiZ2V0TmFtZXNwYWNlSW5mbyIsIm93bnNOYW1lIiwib3duZXJBZGRyZXNzIiwibmFtZUluZm8iLCJhZGRyZXNzIiwicmV2ZWFsZWROYW1lc3BhY2UiLCJyZXZlYWxBZGRyZXNzIiwibmFtZXNwYWNlSW5mbyIsInJlY2lwaWVudF9hZGRyZXNzIiwibmFtZXNwYWNlSXNSZWFkeSIsInJlYWR5IiwibmFtZXNwYWNlSXNSZXZlYWxlZCIsImlzSW5HcmFjZVBlcmlvZCIsImFsbCIsImdldEJsb2NrSGVpZ2h0IiwiZ2V0R3JhY2VQZXJpb2QiLCJibG9ja0hlaWdodCIsImdyYWNlUGVyaW9kIiwiZXhwaXJlc0F0IiwiZXhwaXJlX2Jsb2NrIiwiYWRkcmVzc0NhblJlY2VpdmVOYW1lIiwiZ2V0TmFtZXNPd25lZCIsIm5hbWVzIiwibWFwIiwibmFtZSIsInZhbGlkTmFtZXMiLCJmaWx0ZXIiLCJuYW1lVmFsaWQiLCJpc0FjY291bnRTcGVuZGFibGUiLCJ0b2tlblR5cGUiLCJnZXRBY2NvdW50U3RhdHVzIiwiYWNjb3VudFN0YXR1cyIsInRyYW5zZmVyX3NlbmRfYmxvY2tfaWQiLCJzYWZldHkiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7O0FBRUEsU0FBU0EsV0FBVCxDQUFxQkMsa0JBQTJCLEdBQUcsRUFBbkQsRUFBdUQ7QUFDckQsUUFBTUMsY0FBYyxHQUFHLGlCQUF2QjtBQUNBLFFBQU1DLGVBQWUsR0FBRyxFQUF4Qjs7QUFFQSxNQUFJLENBQUNGLGtCQUFELElBQ0dBLGtCQUFrQixDQUFDRyxNQUFuQixHQUE0QkQsZUFEbkMsRUFDb0Q7QUFDbEQsV0FBT0UsT0FBTyxDQUFDQyxPQUFSLENBQWdCLEtBQWhCLENBQVA7QUFDRDs7QUFDRCxRQUFNQyxTQUFTLEdBQUdOLGtCQUFrQixDQUFDTyxLQUFuQixDQUF5QixHQUF6QixDQUFsQjs7QUFDQSxNQUFJRCxTQUFTLENBQUNILE1BQVYsS0FBcUIsQ0FBekIsRUFBNEI7QUFDMUIsV0FBT0MsT0FBTyxDQUFDQyxPQUFSLENBQWdCLEtBQWhCLENBQVA7QUFDRDs7QUFDRCxTQUFPRCxPQUFPLENBQUNDLE9BQVIsQ0FDTEMsU0FBUyxDQUFDRSxNQUFWLENBQ0UsQ0FBQ0MsR0FBRCxFQUFNQyxRQUFOLEtBQW1CO0FBQ2pCLFFBQUksQ0FBQ0QsR0FBTCxFQUFVO0FBQ1IsYUFBTyxLQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsYUFBT1IsY0FBYyxDQUFDVSxJQUFmLENBQW9CRCxRQUFwQixDQUFQO0FBQ0Q7QUFDRixHQVBILEVBT0ssSUFQTCxDQURLLENBQVA7QUFXRDs7QUFFRCxTQUFTRSxnQkFBVCxDQUEwQkMsV0FBMUIsRUFBK0M7QUFDN0MsUUFBTUMsY0FBYyxHQUFHLHFCQUF2QjtBQUNBLFNBQU9WLE9BQU8sQ0FBQ0MsT0FBUixDQUNMUSxXQUFXLENBQUNFLEtBQVosQ0FBa0JELGNBQWxCLE1BQXNDLElBRGpDLENBQVA7QUFHRDs7QUFFRCxTQUFTRSxlQUFULENBQXlCaEIsa0JBQXpCLEVBQXFEO0FBQ25ELFNBQU9pQixlQUFPQyxPQUFQLENBQWVDLFdBQWYsQ0FBMkJuQixrQkFBM0IsRUFDSm9CLElBREksQ0FDQyxNQUFNLEtBRFAsRUFFSkMsS0FGSSxDQUVHQyxDQUFELElBQU87QUFDWixRQUFJQSxDQUFDLENBQUNDLE9BQUYsS0FBYyxnQkFBbEIsRUFBb0M7QUFDbEMsYUFBTyxJQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsWUFBTUQsQ0FBTjtBQUNEO0FBQ0YsR0FSSSxDQUFQO0FBU0Q7O0FBRUQsU0FBU0Usb0JBQVQsQ0FBOEJYLFdBQTlCLEVBQW1EO0FBQ2pELFNBQU9JLGVBQU9DLE9BQVAsQ0FBZU8sZ0JBQWYsQ0FBZ0NaLFdBQWhDLEVBQ0pPLElBREksQ0FDQyxNQUFNLEtBRFAsRUFFSkMsS0FGSSxDQUVHQyxDQUFELElBQU87QUFDWixRQUFJQSxDQUFDLENBQUNDLE9BQUYsS0FBYyxxQkFBbEIsRUFBeUM7QUFDdkMsYUFBTyxJQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsWUFBTUQsQ0FBTjtBQUNEO0FBQ0YsR0FSSSxDQUFQO0FBU0Q7O0FBRUQsU0FBU0ksUUFBVCxDQUFrQjFCLGtCQUFsQixFQUE4QzJCLFlBQTlDLEVBQW9FO0FBQ2xFLFNBQU9WLGVBQU9DLE9BQVAsQ0FBZUMsV0FBZixDQUEyQm5CLGtCQUEzQixFQUNKb0IsSUFESSxDQUNDUSxRQUFRLElBQUlBLFFBQVEsQ0FBQ0MsT0FBVCxLQUFxQkYsWUFEbEMsRUFFSk4sS0FGSSxDQUVHQyxDQUFELElBQU87QUFDWixRQUFJQSxDQUFDLENBQUNDLE9BQUYsS0FBYyxnQkFBbEIsRUFBb0M7QUFDbEMsYUFBTyxLQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsWUFBTUQsQ0FBTjtBQUNEO0FBQ0YsR0FSSSxDQUFQO0FBU0Q7O0FBRUQsU0FBU1EsaUJBQVQsQ0FBMkJqQixXQUEzQixFQUFnRGtCLGFBQWhELEVBQXVFO0FBQ3JFLFNBQU9kLGVBQU9DLE9BQVAsQ0FBZU8sZ0JBQWYsQ0FBZ0NaLFdBQWhDLEVBQ0pPLElBREksQ0FDQ1ksYUFBYSxJQUFJQSxhQUFhLENBQUNDLGlCQUFkLEtBQW9DRixhQUR0RCxFQUVKVixLQUZJLENBRUdDLENBQUQsSUFBTztBQUNaLFFBQUlBLENBQUMsQ0FBQ0MsT0FBRixLQUFjLHFCQUFsQixFQUF5QztBQUN2QyxhQUFPLEtBQVA7QUFDRCxLQUZELE1BRU87QUFDTCxZQUFNRCxDQUFOO0FBQ0Q7QUFDRixHQVJJLENBQVA7QUFTRDs7QUFFRCxTQUFTWSxnQkFBVCxDQUEwQnJCLFdBQTFCLEVBQStDO0FBQzdDLFNBQU9JLGVBQU9DLE9BQVAsQ0FBZU8sZ0JBQWYsQ0FBZ0NaLFdBQWhDLEVBQ0pPLElBREksQ0FDQ1ksYUFBYSxJQUFJQSxhQUFhLENBQUNHLEtBRGhDLEVBRUpkLEtBRkksQ0FFR0MsQ0FBRCxJQUFPO0FBQ1osUUFBSUEsQ0FBQyxDQUFDQyxPQUFGLEtBQWMscUJBQWxCLEVBQXlDO0FBQ3ZDLGFBQU8sS0FBUDtBQUNELEtBRkQsTUFFTztBQUNMLFlBQU1ELENBQU47QUFDRDtBQUNGLEdBUkksQ0FBUDtBQVNEOztBQUVELFNBQVNjLG1CQUFULENBQTZCdkIsV0FBN0IsRUFBa0Q7QUFDaEQsU0FBT0ksZUFBT0MsT0FBUCxDQUFlTyxnQkFBZixDQUFnQ1osV0FBaEMsRUFDSk8sSUFESSxDQUNDWSxhQUFhLElBQUksQ0FBQ0EsYUFBYSxDQUFDRyxLQURqQyxFQUVKZCxLQUZJLENBRUdDLENBQUQsSUFBTztBQUNaLFFBQUlBLENBQUMsQ0FBQ0MsT0FBRixLQUFjLHFCQUFsQixFQUF5QztBQUN2QyxhQUFPLEtBQVA7QUFDRCxLQUZELE1BRU87QUFDTCxZQUFNRCxDQUFOO0FBQ0Q7QUFDRixHQVJJLENBQVA7QUFTRDs7QUFFRCxTQUFTZSxlQUFULENBQXlCckMsa0JBQXpCLEVBQXFEO0FBQ25ELFFBQU1rQixPQUFPLEdBQUdELGVBQU9DLE9BQXZCO0FBQ0EsU0FBT2QsT0FBTyxDQUFDa0MsR0FBUixDQUFZLENBQUNwQixPQUFPLENBQUNDLFdBQVIsQ0FBb0JuQixrQkFBcEIsQ0FBRCxFQUNDa0IsT0FBTyxDQUFDcUIsY0FBUixFQURELEVBRUNyQixPQUFPLENBQUNzQixjQUFSLENBQXVCeEMsa0JBQXZCLENBRkQsQ0FBWixFQUdKb0IsSUFISSxDQUdDLENBQUMsQ0FBQ1EsUUFBRCxFQUFXYSxXQUFYLEVBQXdCQyxXQUF4QixDQUFELEtBQTBDO0FBQzlDLFVBQU1DLFNBQVMsR0FBR2YsUUFBUSxDQUFDZ0IsWUFBM0I7QUFDQSxXQUFRSCxXQUFXLElBQUlFLFNBQWhCLElBQStCRixXQUFXLEdBQUlDLFdBQVcsR0FBR0MsU0FBbkU7QUFDRCxHQU5JLEVBT0p0QixLQVBJLENBT0dDLENBQUQsSUFBTztBQUNaLFFBQUlBLENBQUMsQ0FBQ0MsT0FBRixLQUFjLGdCQUFsQixFQUFvQztBQUNsQyxhQUFPLEtBQVA7QUFDRCxLQUZELE1BRU87QUFDTCxZQUFNRCxDQUFOO0FBQ0Q7QUFDRixHQWJJLENBQVA7QUFjRDs7QUFFRCxTQUFTdUIscUJBQVQsQ0FBK0JoQixPQUEvQixFQUFnRDtBQUM5QyxTQUFPWixlQUFPQyxPQUFQLENBQWU0QixhQUFmLENBQTZCakIsT0FBN0IsRUFDSlQsSUFESSxDQUNDMkIsS0FBSyxJQUFLM0MsT0FBTyxDQUFDa0MsR0FBUixDQUFZUyxLQUFLLENBQUNDLEdBQU4sQ0FBVUMsSUFBSSxJQUFJbEQsV0FBVyxDQUFDa0QsSUFBRCxDQUE3QixDQUFaLEVBQ2I3QixJQURhLENBQ1I4QixVQUFVLElBQUlBLFVBQVUsQ0FBQ0MsTUFBWCxDQUFrQkMsU0FBUyxJQUFJQSxTQUEvQixFQUEwQ2pELE1BQTFDLEdBQW1ELEVBRHpELENBRFgsQ0FBUDtBQUdEOztBQUVELFNBQVNrRCxrQkFBVCxDQUE0QnhCLE9BQTVCLEVBQTZDeUIsU0FBN0MsRUFBZ0ViLFdBQWhFLEVBQXFGO0FBQ25GLFNBQU94QixlQUFPQyxPQUFQLENBQWVxQyxnQkFBZixDQUFnQzFCLE9BQWhDLEVBQXlDeUIsU0FBekMsRUFDSmxDLElBREksQ0FDQ29DLGFBQWEsSUFBSUEsYUFBYSxDQUFDQyxzQkFBZCxJQUF3Q2hCLFdBRDFELENBQVA7QUFFRDs7QUFFTSxNQUFNaUIsTUFBTSxHQUFHO0FBQ3BCYixFQUFBQSxxQkFEb0I7QUFFcEJSLEVBQUFBLGVBRm9CO0FBR3BCWCxFQUFBQSxRQUhvQjtBQUlwQlYsRUFBQUEsZUFKb0I7QUFLcEJqQixFQUFBQSxXQUxvQjtBQU1wQmEsRUFBQUEsZ0JBTm9CO0FBT3BCWSxFQUFBQSxvQkFQb0I7QUFRcEJNLEVBQUFBLGlCQVJvQjtBQVNwQkksRUFBQUEsZ0JBVG9CO0FBVXBCRSxFQUFBQSxtQkFWb0I7QUFXcEJpQixFQUFBQTtBQVhvQixDQUFmIiwic291cmNlc0NvbnRlbnQiOlsiLyogQGZsb3cgKi9cblxuaW1wb3J0IHsgY29uZmlnIH0gZnJvbSAnLi4vY29uZmlnJ1xuXG5mdW5jdGlvbiBpc05hbWVWYWxpZChmdWxseVF1YWxpZmllZE5hbWU6ID9zdHJpbmcgPSAnJykge1xuICBjb25zdCBOQU1FX1BBUlRfUlVMRSA9IC9eW2EtejAtOVxcLV8rXSskL1xuICBjb25zdCBMRU5HVEhfTUFYX05BTUUgPSAzN1xuXG4gIGlmICghZnVsbHlRdWFsaWZpZWROYW1lXG4gICAgICB8fCBmdWxseVF1YWxpZmllZE5hbWUubGVuZ3RoID4gTEVOR1RIX01BWF9OQU1FKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSlcbiAgfVxuICBjb25zdCBuYW1lUGFydHMgPSBmdWxseVF1YWxpZmllZE5hbWUuc3BsaXQoJy4nKVxuICBpZiAobmFtZVBhcnRzLmxlbmd0aCAhPT0gMikge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpXG4gIH1cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShcbiAgICBuYW1lUGFydHMucmVkdWNlKFxuICAgICAgKGFnZywgbmFtZVBhcnQpID0+IHtcbiAgICAgICAgaWYgKCFhZ2cpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gTkFNRV9QQVJUX1JVTEUudGVzdChuYW1lUGFydClcbiAgICAgICAgfVxuICAgICAgfSwgdHJ1ZVxuICAgIClcbiAgKVxufVxuXG5mdW5jdGlvbiBpc05hbWVzcGFjZVZhbGlkKG5hbWVzcGFjZUlEOiBzdHJpbmcpIHtcbiAgY29uc3QgTkFNRVNQQUNFX1JVTEUgPSAvXlthLXowLTlcXC1fXXsxLDE5fSQvXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoXG4gICAgbmFtZXNwYWNlSUQubWF0Y2goTkFNRVNQQUNFX1JVTEUpICE9PSBudWxsXG4gIClcbn1cblxuZnVuY3Rpb24gaXNOYW1lQXZhaWxhYmxlKGZ1bGx5UXVhbGlmaWVkTmFtZTogc3RyaW5nKSB7XG4gIHJldHVybiBjb25maWcubmV0d29yay5nZXROYW1lSW5mbyhmdWxseVF1YWxpZmllZE5hbWUpXG4gICAgLnRoZW4oKCkgPT4gZmFsc2UpXG4gICAgLmNhdGNoKChlKSA9PiB7XG4gICAgICBpZiAoZS5tZXNzYWdlID09PSAnTmFtZSBub3QgZm91bmQnKSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlXG4gICAgICB9XG4gICAgfSlcbn1cblxuZnVuY3Rpb24gaXNOYW1lc3BhY2VBdmFpbGFibGUobmFtZXNwYWNlSUQ6IHN0cmluZykge1xuICByZXR1cm4gY29uZmlnLm5ldHdvcmsuZ2V0TmFtZXNwYWNlSW5mbyhuYW1lc3BhY2VJRClcbiAgICAudGhlbigoKSA9PiBmYWxzZSlcbiAgICAuY2F0Y2goKGUpID0+IHtcbiAgICAgIGlmIChlLm1lc3NhZ2UgPT09ICdOYW1lc3BhY2Ugbm90IGZvdW5kJykge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZVxuICAgICAgfVxuICAgIH0pXG59ICAgICAgIFxuXG5mdW5jdGlvbiBvd25zTmFtZShmdWxseVF1YWxpZmllZE5hbWU6IHN0cmluZywgb3duZXJBZGRyZXNzOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGNvbmZpZy5uZXR3b3JrLmdldE5hbWVJbmZvKGZ1bGx5UXVhbGlmaWVkTmFtZSlcbiAgICAudGhlbihuYW1lSW5mbyA9PiBuYW1lSW5mby5hZGRyZXNzID09PSBvd25lckFkZHJlc3MpXG4gICAgLmNhdGNoKChlKSA9PiB7XG4gICAgICBpZiAoZS5tZXNzYWdlID09PSAnTmFtZSBub3QgZm91bmQnKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZVxuICAgICAgfVxuICAgIH0pXG59XG5cbmZ1bmN0aW9uIHJldmVhbGVkTmFtZXNwYWNlKG5hbWVzcGFjZUlEOiBzdHJpbmcsIHJldmVhbEFkZHJlc3M6IHN0cmluZykge1xuICByZXR1cm4gY29uZmlnLm5ldHdvcmsuZ2V0TmFtZXNwYWNlSW5mbyhuYW1lc3BhY2VJRClcbiAgICAudGhlbihuYW1lc3BhY2VJbmZvID0+IG5hbWVzcGFjZUluZm8ucmVjaXBpZW50X2FkZHJlc3MgPT09IHJldmVhbEFkZHJlc3MpXG4gICAgLmNhdGNoKChlKSA9PiB7XG4gICAgICBpZiAoZS5tZXNzYWdlID09PSAnTmFtZXNwYWNlIG5vdCBmb3VuZCcpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlXG4gICAgICB9XG4gICAgfSlcbn1cblxuZnVuY3Rpb24gbmFtZXNwYWNlSXNSZWFkeShuYW1lc3BhY2VJRDogc3RyaW5nKSB7XG4gIHJldHVybiBjb25maWcubmV0d29yay5nZXROYW1lc3BhY2VJbmZvKG5hbWVzcGFjZUlEKVxuICAgIC50aGVuKG5hbWVzcGFjZUluZm8gPT4gbmFtZXNwYWNlSW5mby5yZWFkeSlcbiAgICAuY2F0Y2goKGUpID0+IHtcbiAgICAgIGlmIChlLm1lc3NhZ2UgPT09ICdOYW1lc3BhY2Ugbm90IGZvdW5kJykge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVcbiAgICAgIH1cbiAgICB9KVxufVxuXG5mdW5jdGlvbiBuYW1lc3BhY2VJc1JldmVhbGVkKG5hbWVzcGFjZUlEOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGNvbmZpZy5uZXR3b3JrLmdldE5hbWVzcGFjZUluZm8obmFtZXNwYWNlSUQpXG4gICAgLnRoZW4obmFtZXNwYWNlSW5mbyA9PiAhbmFtZXNwYWNlSW5mby5yZWFkeSlcbiAgICAuY2F0Y2goKGUpID0+IHtcbiAgICAgIGlmIChlLm1lc3NhZ2UgPT09ICdOYW1lc3BhY2Ugbm90IGZvdW5kJykge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVcbiAgICAgIH1cbiAgICB9KVxufVxuXG5mdW5jdGlvbiBpc0luR3JhY2VQZXJpb2QoZnVsbHlRdWFsaWZpZWROYW1lOiBzdHJpbmcpIHtcbiAgY29uc3QgbmV0d29yayA9IGNvbmZpZy5uZXR3b3JrXG4gIHJldHVybiBQcm9taXNlLmFsbChbbmV0d29yay5nZXROYW1lSW5mbyhmdWxseVF1YWxpZmllZE5hbWUpLFxuICAgICAgICAgICAgICAgICAgICAgIG5ldHdvcmsuZ2V0QmxvY2tIZWlnaHQoKSxcbiAgICAgICAgICAgICAgICAgICAgICBuZXR3b3JrLmdldEdyYWNlUGVyaW9kKGZ1bGx5UXVhbGlmaWVkTmFtZSldKVxuICAgIC50aGVuKChbbmFtZUluZm8sIGJsb2NrSGVpZ2h0LCBncmFjZVBlcmlvZF0pID0+IHtcbiAgICAgIGNvbnN0IGV4cGlyZXNBdCA9IG5hbWVJbmZvLmV4cGlyZV9ibG9ja1xuICAgICAgcmV0dXJuIChibG9ja0hlaWdodCA+PSBleHBpcmVzQXQpICYmIChibG9ja0hlaWdodCA8IChncmFjZVBlcmlvZCArIGV4cGlyZXNBdCkpXG4gICAgfSlcbiAgICAuY2F0Y2goKGUpID0+IHtcbiAgICAgIGlmIChlLm1lc3NhZ2UgPT09ICdOYW1lIG5vdCBmb3VuZCcpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlXG4gICAgICB9XG4gICAgfSlcbn1cblxuZnVuY3Rpb24gYWRkcmVzc0NhblJlY2VpdmVOYW1lKGFkZHJlc3M6IHN0cmluZykge1xuICByZXR1cm4gY29uZmlnLm5ldHdvcmsuZ2V0TmFtZXNPd25lZChhZGRyZXNzKVxuICAgIC50aGVuKG5hbWVzID0+IChQcm9taXNlLmFsbChuYW1lcy5tYXAobmFtZSA9PiBpc05hbWVWYWxpZChuYW1lKSkpXG4gICAgICAudGhlbih2YWxpZE5hbWVzID0+IHZhbGlkTmFtZXMuZmlsdGVyKG5hbWVWYWxpZCA9PiBuYW1lVmFsaWQpLmxlbmd0aCA8IDI1KSkpXG59XG5cbmZ1bmN0aW9uIGlzQWNjb3VudFNwZW5kYWJsZShhZGRyZXNzOiBzdHJpbmcsIHRva2VuVHlwZTogc3RyaW5nLCBibG9ja0hlaWdodDogbnVtYmVyKSB7XG4gIHJldHVybiBjb25maWcubmV0d29yay5nZXRBY2NvdW50U3RhdHVzKGFkZHJlc3MsIHRva2VuVHlwZSlcbiAgICAudGhlbihhY2NvdW50U3RhdHVzID0+IGFjY291bnRTdGF0dXMudHJhbnNmZXJfc2VuZF9ibG9ja19pZCA+PSBibG9ja0hlaWdodClcbn1cblxuZXhwb3J0IGNvbnN0IHNhZmV0eSA9IHtcbiAgYWRkcmVzc0NhblJlY2VpdmVOYW1lLFxuICBpc0luR3JhY2VQZXJpb2QsXG4gIG93bnNOYW1lLFxuICBpc05hbWVBdmFpbGFibGUsXG4gIGlzTmFtZVZhbGlkLFxuICBpc05hbWVzcGFjZVZhbGlkLFxuICBpc05hbWVzcGFjZUF2YWlsYWJsZSxcbiAgcmV2ZWFsZWROYW1lc3BhY2UsXG4gIG5hbWVzcGFjZUlzUmVhZHksXG4gIG5hbWVzcGFjZUlzUmV2ZWFsZWQsXG4gIGlzQWNjb3VudFNwZW5kYWJsZVxufVxuIl19