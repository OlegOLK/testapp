"use strict";

exports.__esModule = true;
exports.makeCoreSessionRequest = makeCoreSessionRequest;
exports.sendCoreSessionRequest = sendCoreSessionRequest;
exports.getCoreSession = getCoreSession;

var _jsontokens = require("jsontokens");

require("cross-fetch/polyfill");

/**
 * Create an authentication token to be sent to the Core API server
 * in order to generate a Core session JWT.
 *
 * @param {String} appDomain  The unique application identifier (e.g. foo.app, www.foo.com, etc).
 * @param {Array} appMethods  The list of API methods this application will need.
 * @param {String} appPrivateKey  The application-specific private key
 * @param {String|null} blockchainID  This is the blockchain ID of the requester
 * @param {String} thisDevice Identifier of the current device
 *
 * @return {String} a JWT signed by the app's private key
 * @deprecated
 * @private
 */
function makeCoreSessionRequest(appDomain, appMethods, appPrivateKey, blockchainID = null, thisDevice = null) {
  if (thisDevice === null) {
    thisDevice = '.default';
  }

  const appPublicKey = _jsontokens.SECP256K1Client.derivePublicKey(appPrivateKey);

  const appPublicKeys = [{
    public_key: appPublicKey,
    device_id: thisDevice
  }];
  const authBody = {
    version: 1,
    blockchain_id: blockchainID,
    app_private_key: appPrivateKey,
    app_domain: appDomain,
    methods: appMethods,
    app_public_keys: appPublicKeys,
    device_id: thisDevice // make token

  };
  const tokenSigner = new _jsontokens.TokenSigner('ES256k', appPrivateKey);
  const token = tokenSigner.sign(authBody);
  return token;
}
/**
 * Send Core a request for a session token.
 *
 * @param {String} coreHost host name of the core node
 * @param {Number} corePort port number of the core node
 * @param {String} coreAuthRequest  a signed JWT encoding the authentication request
 * @param {String} apiPassword the API password for Core
 *
 * @return {Promise} the resolves to a JWT signed with the Core API server's private key
 * that authorizes the bearer to carry out the requested operations and rejects
 * with an error message otherwise
 * @deprecated
 * @private
 */


function sendCoreSessionRequest(coreHost, corePort, coreAuthRequest, apiPassword) {
  return Promise.resolve().then(() => {
    if (!apiPassword) {
      throw new Error('Missing API password');
    }
  }).then(() => {
    const options = {
      headers: {
        Authorization: `bearer ${apiPassword}`
      }
    };
    const url = `http://${coreHost}:${corePort}/v1/auth?authRequest=${coreAuthRequest}`;
    return fetch(url, options);
  }).then(response => {
    if (!response.ok) {
      throw new Error('HTTP status not OK');
    }

    return response.text();
  }).then(responseText => {
    const responseJson = JSON.parse(responseText);
    const token = responseJson.token;

    if (!token) {
      throw new Error('Failed to get Core session token');
    }

    return token;
  }).catch(error => {
    console.error(error);
    throw new Error('Invalid Core response: not JSON');
  });
}
/**
 * Get a core session token.  Generate an auth request, sign it, send it to Core,
 * and get back a session token.
 *
 * @param {String} coreHost Core API server's hostname
 * @param {Number} corePort Core API server's port number
 * @param {String} apiPassword core api password
 * @param  {String} appPrivateKey Application's private key
 * @param  {String} blockchainId blockchain ID of the user signing in.
 * `null` if user has no blockchain ID
 * @param {String} authRequest authentication request token
 * @param {String} deviceId identifier for the current device
 *
 * @return {Promise} a Promise that resolves to a Core session token or rejects
 * with an error message.
 * @deprecated
 * @private
 */


function getCoreSession(coreHost, corePort, apiPassword, appPrivateKey, blockchainId = null, authRequest = null, deviceId = '0') {
  if (!authRequest) {
    return Promise.reject('No authRequest provided');
  }

  let payload = null;
  let authRequestObject = null;

  try {
    authRequestObject = (0, _jsontokens.decodeToken)(authRequest);

    if (!authRequestObject) {
      return Promise.reject('Invalid authRequest in URL query string');
    }

    if (!authRequestObject.payload) {
      return Promise.reject('Invalid authRequest in URL query string');
    }

    payload = authRequestObject.payload;
  } catch (e) {
    console.error(e.stack);
    return Promise.reject('Failed to parse authRequest in URL');
  }

  const appDomain = payload.domain_name;

  if (!appDomain) {
    return Promise.reject('No domain_name in authRequest');
  }

  const appMethods = payload.scopes;
  const coreAuthRequest = makeCoreSessionRequest(appDomain, appMethods, appPrivateKey, blockchainId, deviceId);
  return sendCoreSessionRequest(coreHost, corePort, coreAuthRequest, apiPassword);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hdXRoL2F1dGhTZXNzaW9uLmpzIl0sIm5hbWVzIjpbIm1ha2VDb3JlU2Vzc2lvblJlcXVlc3QiLCJhcHBEb21haW4iLCJhcHBNZXRob2RzIiwiYXBwUHJpdmF0ZUtleSIsImJsb2NrY2hhaW5JRCIsInRoaXNEZXZpY2UiLCJhcHBQdWJsaWNLZXkiLCJTRUNQMjU2SzFDbGllbnQiLCJkZXJpdmVQdWJsaWNLZXkiLCJhcHBQdWJsaWNLZXlzIiwicHVibGljX2tleSIsImRldmljZV9pZCIsImF1dGhCb2R5IiwidmVyc2lvbiIsImJsb2NrY2hhaW5faWQiLCJhcHBfcHJpdmF0ZV9rZXkiLCJhcHBfZG9tYWluIiwibWV0aG9kcyIsImFwcF9wdWJsaWNfa2V5cyIsInRva2VuU2lnbmVyIiwiVG9rZW5TaWduZXIiLCJ0b2tlbiIsInNpZ24iLCJzZW5kQ29yZVNlc3Npb25SZXF1ZXN0IiwiY29yZUhvc3QiLCJjb3JlUG9ydCIsImNvcmVBdXRoUmVxdWVzdCIsImFwaVBhc3N3b3JkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJ0aGVuIiwiRXJyb3IiLCJvcHRpb25zIiwiaGVhZGVycyIsIkF1dGhvcml6YXRpb24iLCJ1cmwiLCJmZXRjaCIsInJlc3BvbnNlIiwib2siLCJ0ZXh0IiwicmVzcG9uc2VUZXh0IiwicmVzcG9uc2VKc29uIiwiSlNPTiIsInBhcnNlIiwiY2F0Y2giLCJlcnJvciIsImNvbnNvbGUiLCJnZXRDb3JlU2Vzc2lvbiIsImJsb2NrY2hhaW5JZCIsImF1dGhSZXF1ZXN0IiwiZGV2aWNlSWQiLCJyZWplY3QiLCJwYXlsb2FkIiwiYXV0aFJlcXVlc3RPYmplY3QiLCJlIiwic3RhY2siLCJkb21haW5fbmFtZSIsInNjb3BlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQUNBOztBQUVBOzs7Ozs7Ozs7Ozs7OztBQWNPLFNBQVNBLHNCQUFULENBQWdDQyxTQUFoQyxFQUNnQ0MsVUFEaEMsRUFFZ0NDLGFBRmhDLEVBR2dDQyxZQUFxQixH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b2tlblNpZ25lciwgZGVjb2RlVG9rZW4sIFNFQ1AyNTZLMUNsaWVudCB9IGZyb20gJ2pzb250b2tlbnMnXG5pbXBvcnQgJ2Nyb3NzLWZldGNoL3BvbHlmaWxsJ1xuXG4vKipcbiAqIENyZWF0ZSBhbiBhdXRoZW50aWNhdGlvbiB0b2tlbiB0byBiZSBzZW50IHRvIHRoZSBDb3JlIEFQSSBzZXJ2ZXJcbiAqIGluIG9yZGVyIHRvIGdlbmVyYXRlIGEgQ29yZSBzZXNzaW9uIEpXVC5cbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gYXBwRG9tYWluICBUaGUgdW5pcXVlIGFwcGxpY2F0aW9uIGlkZW50aWZpZXIgKGUuZy4gZm9vLmFwcCwgd3d3LmZvby5jb20sIGV0YykuXG4gKiBAcGFyYW0ge0FycmF5fSBhcHBNZXRob2RzICBUaGUgbGlzdCBvZiBBUEkgbWV0aG9kcyB0aGlzIGFwcGxpY2F0aW9uIHdpbGwgbmVlZC5cbiAqIEBwYXJhbSB7U3RyaW5nfSBhcHBQcml2YXRlS2V5ICBUaGUgYXBwbGljYXRpb24tc3BlY2lmaWMgcHJpdmF0ZSBrZXlcbiAqIEBwYXJhbSB7U3RyaW5nfG51bGx9IGJsb2NrY2hhaW5JRCAgVGhpcyBpcyB0aGUgYmxvY2tjaGFpbiBJRCBvZiB0aGUgcmVxdWVzdGVyXG4gKiBAcGFyYW0ge1N0cmluZ30gdGhpc0RldmljZSBJZGVudGlmaWVyIG9mIHRoZSBjdXJyZW50IGRldmljZVxuICpcbiAqIEByZXR1cm4ge1N0cmluZ30gYSBKV1Qgc2lnbmVkIGJ5IHRoZSBhcHAncyBwcml2YXRlIGtleVxuICogQGRlcHJlY2F0ZWRcbiAqIEBwcml2YXRlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtYWtlQ29yZVNlc3Npb25SZXF1ZXN0KGFwcERvbWFpbjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwTWV0aG9kczogQXJyYXk8c3RyaW5nPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcFByaXZhdGVLZXk6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrY2hhaW5JRDogP3N0cmluZyA9IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzRGV2aWNlOiA/c3RyaW5nID0gbnVsbCkge1xuICBpZiAodGhpc0RldmljZSA9PT0gbnVsbCkge1xuICAgIHRoaXNEZXZpY2UgPSAnLmRlZmF1bHQnXG4gIH1cblxuICBjb25zdCBhcHBQdWJsaWNLZXkgPSBTRUNQMjU2SzFDbGllbnQuZGVyaXZlUHVibGljS2V5KGFwcFByaXZhdGVLZXkpXG4gIGNvbnN0IGFwcFB1YmxpY0tleXMgPSBbe1xuICAgIHB1YmxpY19rZXk6IGFwcFB1YmxpY0tleSxcbiAgICBkZXZpY2VfaWQ6IHRoaXNEZXZpY2VcbiAgfV1cblxuICBjb25zdCBhdXRoQm9keSA9IHtcbiAgICB2ZXJzaW9uOiAxLFxuICAgIGJsb2NrY2hhaW5faWQ6IGJsb2NrY2hhaW5JRCxcbiAgICBhcHBfcHJpdmF0ZV9rZXk6IGFwcFByaXZhdGVLZXksXG4gICAgYXBwX2RvbWFpbjogYXBwRG9tYWluLFxuICAgIG1ldGhvZHM6IGFwcE1ldGhvZHMsXG4gICAgYXBwX3B1YmxpY19rZXlzOiBhcHBQdWJsaWNLZXlzLFxuICAgIGRldmljZV9pZDogdGhpc0RldmljZVxuICB9XG5cbiAgLy8gbWFrZSB0b2tlblxuICBjb25zdCB0b2tlblNpZ25lciA9IG5ldyBUb2tlblNpZ25lcignRVMyNTZrJywgYXBwUHJpdmF0ZUtleSlcbiAgY29uc3QgdG9rZW4gPSB0b2tlblNpZ25lci5zaWduKGF1dGhCb2R5KVxuXG4gIHJldHVybiB0b2tlblxufVxuXG5cbi8qKlxuICogU2VuZCBDb3JlIGEgcmVxdWVzdCBmb3IgYSBzZXNzaW9uIHRva2VuLlxuICpcbiAqIEBwYXJhbSB7U3RyaW5nfSBjb3JlSG9zdCBob3N0IG5hbWUgb2YgdGhlIGNvcmUgbm9kZVxuICogQHBhcmFtIHtOdW1iZXJ9IGNvcmVQb3J0IHBvcnQgbnVtYmVyIG9mIHRoZSBjb3JlIG5vZGVcbiAqIEBwYXJhbSB7U3RyaW5nfSBjb3JlQXV0aFJlcXVlc3QgIGEgc2lnbmVkIEpXVCBlbmNvZGluZyB0aGUgYXV0aGVudGljYXRpb24gcmVxdWVzdFxuICogQHBhcmFtIHtTdHJpbmd9IGFwaVBhc3N3b3JkIHRoZSBBUEkgcGFzc3dvcmQgZm9yIENvcmVcbiAqXG4gKiBAcmV0dXJuIHtQcm9taXNlfSB0aGUgcmVzb2x2ZXMgdG8gYSBKV1Qgc2lnbmVkIHdpdGggdGhlIENvcmUgQVBJIHNlcnZlcidzIHByaXZhdGUga2V5XG4gKiB0aGF0IGF1dGhvcml6ZXMgdGhlIGJlYXJlciB0byBjYXJyeSBvdXQgdGhlIHJlcXVlc3RlZCBvcGVyYXRpb25zIGFuZCByZWplY3RzXG4gKiB3aXRoIGFuIGVycm9yIG1lc3NhZ2Ugb3RoZXJ3aXNlXG4gKiBAZGVwcmVjYXRlZFxuICogQHByaXZhdGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNlbmRDb3JlU2Vzc2lvblJlcXVlc3QoY29yZUhvc3Q6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvcmVQb3J0OiBudW1iZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3JlQXV0aFJlcXVlc3Q6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwaVBhc3N3b3JkOiBzdHJpbmcpIHtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4ge1xuICAgIGlmICghYXBpUGFzc3dvcmQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBBUEkgcGFzc3dvcmQnKVxuICAgIH1cbiAgfSlcbiAgICAudGhlbigoKSA9PiB7XG4gICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgQXV0aG9yaXphdGlvbjogYGJlYXJlciAke2FwaVBhc3N3b3JkfWBcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3QgdXJsID0gYGh0dHA6Ly8ke2NvcmVIb3N0fToke2NvcmVQb3J0fS92MS9hdXRoP2F1dGhSZXF1ZXN0PSR7Y29yZUF1dGhSZXF1ZXN0fWBcbiAgICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpXG4gICAgfSlcbiAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdIVFRQIHN0YXR1cyBub3QgT0snKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLnRleHQoKVxuICAgIH0pXG4gICAgLnRoZW4oKHJlc3BvbnNlVGV4dCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2VKc29uID0gSlNPTi5wYXJzZShyZXNwb25zZVRleHQpXG4gICAgICBjb25zdCB0b2tlbiA9IHJlc3BvbnNlSnNvbi50b2tlblxuICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBnZXQgQ29yZSBzZXNzaW9uIHRva2VuJylcbiAgICAgIH1cbiAgICAgIHJldHVybiB0b2tlblxuICAgIH0pXG4gICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcihlcnJvcilcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBDb3JlIHJlc3BvbnNlOiBub3QgSlNPTicpXG4gICAgfSlcbn1cblxuXG4vKipcbiAqIEdldCBhIGNvcmUgc2Vzc2lvbiB0b2tlbi4gIEdlbmVyYXRlIGFuIGF1dGggcmVxdWVzdCwgc2lnbiBpdCwgc2VuZCBpdCB0byBDb3JlLFxuICogYW5kIGdldCBiYWNrIGEgc2Vzc2lvbiB0b2tlbi5cbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gY29yZUhvc3QgQ29yZSBBUEkgc2VydmVyJ3MgaG9zdG5hbWVcbiAqIEBwYXJhbSB7TnVtYmVyfSBjb3JlUG9ydCBDb3JlIEFQSSBzZXJ2ZXIncyBwb3J0IG51bWJlclxuICogQHBhcmFtIHtTdHJpbmd9IGFwaVBhc3N3b3JkIGNvcmUgYXBpIHBhc3N3b3JkXG4gKiBAcGFyYW0gIHtTdHJpbmd9IGFwcFByaXZhdGVLZXkgQXBwbGljYXRpb24ncyBwcml2YXRlIGtleVxuICogQHBhcmFtICB7U3RyaW5nfSBibG9ja2NoYWluSWQgYmxvY2tjaGFpbiBJRCBvZiB0aGUgdXNlciBzaWduaW5nIGluLlxuICogYG51bGxgIGlmIHVzZXIgaGFzIG5vIGJsb2NrY2hhaW4gSURcbiAqIEBwYXJhbSB7U3RyaW5nfSBhdXRoUmVxdWVzdCBhdXRoZW50aWNhdGlvbiByZXF1ZXN0IHRva2VuXG4gKiBAcGFyYW0ge1N0cmluZ30gZGV2aWNlSWQgaWRlbnRpZmllciBmb3IgdGhlIGN1cnJlbnQgZGV2aWNlXG4gKlxuICogQHJldHVybiB7UHJvbWlzZX0gYSBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gYSBDb3JlIHNlc3Npb24gdG9rZW4gb3IgcmVqZWN0c1xuICogd2l0aCBhbiBlcnJvciBtZXNzYWdlLlxuICogQGRlcHJlY2F0ZWRcbiAqIEBwcml2YXRlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb3JlU2Vzc2lvbihjb3JlSG9zdDogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvcmVQb3J0OiBudW1iZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpUGFzc3dvcmQ6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBQcml2YXRlS2V5OiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tjaGFpbklkOiA/c3RyaW5nID0gbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRoUmVxdWVzdDogP3N0cmluZyA9IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlSWQ6IHN0cmluZyA9ICcwJykge1xuICBpZiAoIWF1dGhSZXF1ZXN0KSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCdObyBhdXRoUmVxdWVzdCBwcm92aWRlZCcpXG4gIH1cblxuICBsZXQgcGF5bG9hZCA9IG51bGxcbiAgbGV0IGF1dGhSZXF1ZXN0T2JqZWN0ID0gbnVsbFxuICB0cnkge1xuICAgIGF1dGhSZXF1ZXN0T2JqZWN0ID0gZGVjb2RlVG9rZW4oYXV0aFJlcXVlc3QpXG4gICAgaWYgKCFhdXRoUmVxdWVzdE9iamVjdCkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCdJbnZhbGlkIGF1dGhSZXF1ZXN0IGluIFVSTCBxdWVyeSBzdHJpbmcnKVxuICAgIH1cbiAgICBpZiAoIWF1dGhSZXF1ZXN0T2JqZWN0LnBheWxvYWQpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgnSW52YWxpZCBhdXRoUmVxdWVzdCBpbiBVUkwgcXVlcnkgc3RyaW5nJylcbiAgICB9XG4gICAgcGF5bG9hZCA9IGF1dGhSZXF1ZXN0T2JqZWN0LnBheWxvYWRcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoZS5zdGFjaylcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoJ0ZhaWxlZCB0byBwYXJzZSBhdXRoUmVxdWVzdCBpbiBVUkwnKVxuICB9XG5cbiAgY29uc3QgYXBwRG9tYWluID0gcGF5bG9hZC5kb21haW5fbmFtZVxuICBpZiAoIWFwcERvbWFpbikge1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgnTm8gZG9tYWluX25hbWUgaW4gYXV0aFJlcXVlc3QnKVxuICB9XG4gIGNvbnN0IGFwcE1ldGhvZHMgPSBwYXlsb2FkLnNjb3Blc1xuXG4gIGNvbnN0IGNvcmVBdXRoUmVxdWVzdCA9IG1ha2VDb3JlU2Vzc2lvblJlcXVlc3QoXG4gICAgYXBwRG9tYWluLCBhcHBNZXRob2RzLCBhcHBQcml2YXRlS2V5LCBibG9ja2NoYWluSWQsIGRldmljZUlkXG4gIClcblxuICByZXR1cm4gc2VuZENvcmVTZXNzaW9uUmVxdWVzdChcbiAgICBjb3JlSG9zdCwgY29yZVBvcnQsIGNvcmVBdXRoUmVxdWVzdCwgYXBpUGFzc3dvcmRcbiAgKVxufVxuIl19